name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]
    branches: [main]

jobs:
  claude-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Check PR Size
        id: pr-size
        run: |
          set -Eeuo pipefail

          MAX_TOTAL_CHANGES=2000
          MAX_FILES=50

          PR_DATA=$(gh pr view ${{ github.event.pull_request.number }} --json additions,deletions,changedFiles,isDraft,title)

          ADDITIONS=$(echo "$PR_DATA" | jq -r '.additions')
          DELETIONS=$(echo "$PR_DATA" | jq -r '.deletions')
          CHANGED_FILES=$(echo "$PR_DATA" | jq -r '.changedFiles')
          IS_DRAFT=$(echo "$PR_DATA" | jq -r '.isDraft')
          PR_TITLE=$(echo "$PR_DATA" | jq -r '.title')
          TOTAL_CHANGES=$((ADDITIONS + DELETIONS))

          echo "PR Statistics:"
          echo "- Files changed: $CHANGED_FILES"
          echo "- Additions: $ADDITIONS"
          echo "- Deletions: $DELETIONS"
          echo "- Total changes: $TOTAL_CHANGES"

          if [[ "$PR_TITLE" == *"[skip-review]"* ]]; then
            echo "skip_review=true" >> $GITHUB_OUTPUT
          elif [ "$IS_DRAFT" = "true" ]; then
            echo "skip_review=true" >> $GITHUB_OUTPUT
          elif [ $TOTAL_CHANGES -gt $MAX_TOTAL_CHANGES ] || [ $CHANGED_FILES -gt $MAX_FILES ]; then
            echo "skip_review=true" >> $GITHUB_OUTPUT
          else
            echo "skip_review=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Run Claude Code Review
        if: |
          steps.pr-size.outputs.skip_review != 'true' &&
          github.event.pull_request.head.repo.full_name == github.repository
        uses: anthropics/claude-code-action@beta
        continue-on-error: true
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          direct_prompt: |
            Please review this pull request for the Good To Go (gtg) Python project.

            Focus on:
            - Code quality and Python best practices
            - Potential bugs or edge cases
            - Security concerns (especially around GitHub token handling)
            - Test coverage
            - Type hints and documentation

            This is a PR readiness detection tool for AI agents. Be constructive.
